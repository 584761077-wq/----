<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="iOS 26">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <title>iOS 26 Liquid Real API</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body :class="[{ 'settings-active': currentView === 'settings' || currentView === 'appearance' || currentView === 'chat' }, { 'text-dark': isDarkText }]">

<div id="app">
    
    <div class="wallpaper-layer" :style="{ backgroundImage: `url(${wallpaperUrl})` }"></div>
    <div class="wallpaper-layer" :style="{ backgroundImage: `url(${chatWallpaperUrl})`, zIndex: currentView === 'chat' ? -1 : -3 }"></div>
    <div class="settings-bg"></div>

    <!-- 1. 桌面 -->
    <div class="desktop-view" :class="{ 'view-hidden': currentView !== 'desktop' }">
        <div class="widget-large">
            <div class="left-matrix">
                <div class="module mod-time"><div class="time-display">{{ hour }}:{{ minute }}</div><div class="date-display">{{ fullDate }}</div></div>
                <div class="module mod-hardware"><i class="fas fa-cat"></i><span>喵~</span></div>
                <div class="module mod-storage"><div class="ring-container" :style="{ '--pct': storagePct + '%' }"><div class="ring-inner">存储</div></div></div>
                <div class="module mod-battery"><div class="liquid" :style="{ height: batteryLevel + '%' }"></div><div class="battery-info"><i class="fas fa-bolt" v-if="charging"></i><span>{{ batteryLevel }}</span></div></div>
            </div>
            <div class="right-visual" @click="uploadImage"><img v-if="imgUrl" :src="imgUrl"><div v-else class="placeholder"><i class="fas fa-image"></i></div><input type="file" ref="fileInput" accept="image/*" style="display:none" @change="handleFile"></div>
        </div>
        <div class="widget-row">
            <div class="widget-small standee-widget">
                <div class="hidden-trigger" @click.stop="uploadStandee"></div>
                <template v-if="standeeUrl"><img :src="standeeUrl" class="standee-img" :class="{ 'is-spinning': spinning }" @click="spinAction"><div class="base-slot"></div><div class="metal-base"></div></template>
                <div v-else class="standee-placeholder" @click="uploadStandee"><i class="fas fa-ghost" style="font-size:24px; margin-bottom:5px;"></i><span>上传PNG</span></div>
                <input type="file" ref="standeeInput" accept="image/png, image/webp" style="display:none" @change="handleStandeeFile">
            </div>
            <div class="widget-small"></div>
        </div>
    </div>

    <!-- 2. Dock -->
    <div class="dock-container" :class="{ 'dock-hidden': currentView !== 'desktop' }">
        <div class="app-icon icon-settings" @click="switchView('settings')"><i class="fas fa-cog"></i></div>
        <div class="app-icon icon-appearance" @click="switchView('appearance')"><i class="fas fa-palette"></i></div>
        <div class="app-icon icon-chat" @click="switchView('chat')"><i class="fas fa-comment"></i></div>
    </div>

    <!-- 3. 极致液态设置 -->
    <div class="settings-view" :class="{ 'active': currentView === 'settings' }">
        <div class="nav-bar">
            <div class="nav-btn" @click="switchView('desktop')"><i class="fas fa-chevron-left"></i> 返回</div>
            <span>API 设置</span>
            <!-- 顶部白色玻璃保存按钮 -->
            <div class="glass-btn-top" @click="saveAndExit">保存</div>
        </div>

        <div class="settings-content">
            <div class="liquid-card">
                <div class="card-title">API Connection</div>
                
                <div class="form-group">
                    <label class="form-label">Endpoint URL</label>
                    <input type="text" class="glass-input" v-model="apiConfig.endpoint" placeholder="https://api.openai.com/v1">
                </div>

                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" class="glass-input" v-model="apiConfig.key" placeholder="sk-...">
                </div>

                <div class="row-group">
                    <div class="glass-btn" @click="fetchModels">
                        <i class="fas fa-sync-alt" :class="{'fa-spin': loadingModels}" style="margin-right:6px"></i> 
                        {{ loadingModels ? '连接中...' : '拉取模型' }}
                    </div>
                    <select class="glass-select" v-model="apiConfig.model" style="color:#000;">
                        <option value="" disabled>选择模型...</option>
                        <option v-for="m in modelList" :key="m" :value="m">{{ m }}</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                    <label class="form-label">预设管理</label>
                    <select class="glass-select" v-model="selectedPresetId" @change="loadPreset" style="width:100%; color:#000;">
                        <option value="" disabled>选择已保存的预设...</option>
                        <option v-for="(p, index) in presets" :key="index" :value="index">{{ p.name }}</option>
                    </select>
                    
                    <!-- 双列矩形按钮 -->
                    <div class="preset-action-row">
                        <div class="rect-btn btn-white" @click="openSaveModal">
                            <i class="fas fa-save" style="margin-right:6px"></i> 保存
                        </div>
                        <div class="rect-btn btn-gray" @click="openDeleteModal">
                            <i class="fas fa-trash" style="margin-right:6px"></i> 删除
                        </div>
                    </div>
                    
                    <!-- 温度滑块 (中文) -->
                    <div class="slider-group">
                        <div class="slider-header">
                            <span>温度</span>
                            <span>{{ apiConfig.temperature }}</span>
                        </div>
                        <input type="range" class="glass-range" min="0" max="2" step="0.1" v-model="apiConfig.temperature">
                    </div>
                </div>
            </div>

            <div class="liquid-card" style="opacity: 0.8; display:flex; justify-content:center; align-items:center;">
                 <span style="font-size:12px; color:rgba(255,255,255,0.6);">Design by Liquid Glass UI</span>
            </div>
        </div>
    </div>

    <!-- 4. 外观设置 -->
    <div class="settings-view" :class="{ 'active': currentView === 'appearance' }">
        <div class="nav-bar">
            <div class="nav-btn" @click="switchView('desktop')"><i class="fas fa-chevron-left"></i> 返回</div>
            <span>外观</span>
            <div style="width: 60px;"></div> <!-- 占位符保持标题居中 -->
        </div>
        <div class="settings-content">
            <div class="liquid-card">
                <div class="card-title">桌面壁纸</div>
                <div class="wallpaper-preview" :style="{ backgroundImage: `url(${wallpaperUrl})` }" @click="uploadWallpaper">
                    <div v-if="!wallpaperUrl" class="wallpaper-preview-placeholder">点击更换壁纸</div>
                </div>
                <input type="file" ref="wallpaperInput" accept="image/*" style="display:none" @change="handleWallpaperFile">
            </div>
            <div class="liquid-card">
                <div class="card-title">Chat App 背景</div>
                <div class="wallpaper-preview" :style="{ backgroundImage: `url(${chatWallpaperUrl})` }" @click="uploadChatWallpaper">
                    <div v-if="!chatWallpaperUrl" class="wallpaper-preview-placeholder">点击更换壁纸</div>
                </div>
                <input type="file" ref="chatWallpaperInput" accept="image/*" style="display:none" @change="handleChatWallpaperFile">
            </div>
            <div class="liquid-card">
                <div class="setting-row">
                    <span class="setting-label">全局字体黑色</span>
                    <div class="glass-toggle" :class="{ active: isDarkText }" @click="isDarkText = !isDarkText">
                        <div class="glass-toggle-handle"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. Chat App -->
    <div class="settings-view" :class="{ 'active': currentView === 'chat' }">
        <div class="nav-bar">
            <div class="nav-btn" @click="switchView('desktop')"><i class="fas fa-chevron-left"></i></div>
            <span>消息</span>
            <div style="width: 60px;"></div> <!-- 占位符保持标题居中 -->
        </div>
        <div class="settings-content">
            <!-- 聊天列表 -->
            <div v-if="currentChatTab === 'chat'">
                <div class="liquid-card contact-card" v-for="contact in contacts" :key="contact.id" @click="openChat(contact)">
                    <div class="contact-avatar"></div>
                    <div class="contact-info">
                        <div class="contact-name">{{ contact.name }}</div>
                        <div class="contact-last-message" v-if="messages[contact.id] && messages[contact.id].length > 0">
                            {{ messages[contact.id][messages[contact.id].length - 1].text }}
                        </div>
                        <div class="contact-last-message" v-else style="color: rgba(255,255,255,0.4); font-style: italic;">
                            暂无消息
                        </div>
                    </div>
                </div>
                <div v-if="contacts.length === 0" class="empty-state">
                    <i class="fas fa-comment-slash" style="font-size: 40px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.6);">暂无联系人</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 5px;">点击下方通讯录添加角色</div>
                </div>
            </div>
            <!-- 通讯录 -->
            <div v-if="currentChatTab === 'contacts'">
                <div class="contact-actions">
                    <div class="capsule-btn" @click="showAddRoleModal = true"><i class="fas fa-user-plus"></i></div>
                    <div class="capsule-btn"><i class="fas fa-users"></i></div>
                </div>
                <div class="liquid-card contact-card" v-for="contact in contacts" :key="contact.id" @click="openChat(contact)">
                    <div class="contact-avatar"></div>
                    <div class="contact-info">
                        <div class="contact-name">{{ contact.name }}</div>
                        <div class="contact-signature">{{ contact.signature }}</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Chat App 内部 Dock -->
        <div class="chat-dock">
            <div class="chat-dock-item" :class="{ active: currentChatTab === 'chat' }" @click="switchChatTab('chat')"><i class="fas fa-comment-dots"></i></div>
            <div class="chat-dock-item" :class="{ active: currentChatTab === 'contacts' }" @click="switchChatTab('contacts')"><i class="fas fa-address-book"></i></div>
            <div class="chat-dock-item" :class="{ active: currentChatTab === 'discover' }" @click="switchChatTab('discover')"><i class="fas fa-compass"></i></div>
            <div class="chat-dock-item" :class="{ active: currentChatTab === 'me' }" @click="switchChatTab('me')"><i class="fas fa-user"></i></div>
        </div>
    </div>

    <!-- 6. Conversation View -->
    <div class="conversation-view" :class="{ active: currentView === 'conversation' }">
        <div class="conversation-header">
            <div class="back-btn" @click="switchView('chat')"><i class="fas fa-chevron-left"></i></div>
            <div class="contact-name">{{ currentConversation.name }}</div>
            <div class="actions">
                <i class="fas fa-video"></i>
                <i class="fas fa-phone"></i>
                <i class="fas fa-cog" @click="openChatSettings" style="cursor: pointer;"></i>
            </div>
        </div>
        <div class="messages-area">
            <div v-for="msg in messages[currentConversation.id] || []" :key="msg.time" class="message-bubble" :class="msg.type">
                {{ msg.text }}
                <div class="timestamp">{{ msg.time }}</div>
            </div>
        </div>
        <div class="conversation-input-area">
            <div class="icon-btn"><i class="fas fa-plus"></i></div>
            <input type="text" class="text-input" placeholder="输入消息..." v-model="newMessage" @keyup.enter="sendMessage">
            <div class="icon-btn send-btn" @click="sendMessage"><i class="fas fa-arrow-up"></i></div>
        </div>
    </div>

    <!-- 7. Chat Settings View -->
    <div class="settings-view" :class="{ 'active': currentView === 'chat-settings' }">
        <div class="nav-bar">
            <div class="nav-btn" @click="switchView('chat')"><i class="fas fa-chevron-left"></i> 返回</div>
            <span>聊天设置</span>
            <div class="glass-btn-top" @click="saveChatSettings">保存</div>
        </div>
        <div class="settings-content">
            <!-- 卡片1: 角色信息 -->
            <div class="liquid-card">
                <div class="card-title">角色信息</div>
                <div class="role-info-container">
                    <!-- Char信息 -->
                    <div class="role-section">
                        <div class="role-header">角色 (Char)</div>
                        <div class="avatar-container" @click="openAvatarModal('char')">
                            <div class="avatar-circle" :style="{ backgroundImage: currentChatSettings.char.avatar ? `url(${currentChatSettings.char.avatar})` : 'none', backgroundColor: currentChatSettings.char.avatar ? 'transparent' : 'rgba(255,255,255,0.2)' }">
                                <i v-if="!currentChatSettings.char.avatar" class="fas fa-user"></i>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">真名</label>
                            <input type="text" class="glass-input" v-model="currentChatSettings.char.realName" placeholder="输入角色真名">
                        </div>
                        <div class="form-group">
                            <label class="form-label">备注名</label>
                            <input type="text" class="glass-input" v-model="currentChatSettings.char.nickname" placeholder="输入备注名">
                        </div>
                    </div>
                    
                    <!-- User信息 -->
                    <div class="role-section">
                        <div class="role-header">用户 (User)</div>
                        <div class="avatar-container" @click="openAvatarModal('user')">
                            <div class="avatar-circle" :style="{ backgroundImage: currentChatSettings.user.avatar ? `url(${currentChatSettings.user.avatar})` : 'none', backgroundColor: currentChatSettings.user.avatar ? 'transparent' : 'rgba(255,255,255,0.2)' }">
                                <i v-if="!currentChatSettings.user.avatar" class="fas fa-user"></i>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">真名</label>
                            <input type="text" class="glass-input" v-model="currentChatSettings.user.realName" placeholder="输入用户真名">
                        </div>
                        <div class="form-group">
                            <label class="form-label">备注名</label>
                            <input type="text" class="glass-input" v-model="currentChatSettings.user.nickname" placeholder="输入备注名">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 卡片2: Char人设 -->
            <div class="liquid-card">
                <div class="card-title">角色人设</div>
                <div class="form-group">
                    <label class="form-label">角色人设</label>
                    <textarea class="glass-textarea" v-model="currentChatSettings.char.personality" placeholder="输入角色的人设描述..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">世界书选择绑定</label>
                    <select class="glass-select" v-model="currentChatSettings.worldbook">
                        <option value="">未选择</option>
                        <option value="worldbook1">世界书1</option>
                        <option value="worldbook2">世界书2</option>
                        <option value="worldbook3">世界书3</option>
                    </select>
                </div>
            </div>

            <!-- 卡片3: User人设 -->
            <div class="liquid-card">
                <div class="card-title">用户人设</div>
                <div class="form-group">
                    <label class="form-label">用户人设</label>
                    <textarea class="glass-textarea" v-model="currentChatSettings.user.personality" placeholder="输入用户的人设描述..." rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">预设管理</label>
                    <div class="row-group">
                        <select class="glass-select" v-model="selectedUserPresetId" @change="loadUserPreset">
                            <option value="" disabled>选择预设...</option>
                            <option v-for="(preset, index) in userPresets" :key="index" :value="index">{{ preset.name }}</option>
                        </select>
                        <div class="glass-btn" @click="applyUserPreset">
                            <i class="fas fa-check" style="margin-right:6px"></i> 应用
                        </div>
                    </div>
                    
                    <div class="preset-action-row">
                        <div class="rect-btn btn-white" @click="openSaveUserPresetModal">
                            <i class="fas fa-save" style="margin-right:6px"></i> 保存为预设
                        </div>
                        <div class="rect-btn btn-gray" @click="openDeleteUserPresetModal">
                            <i class="fas fa-trash" style="margin-right:6px"></i> 删除预设
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 弹窗 -->
    <div class="modal-overlay" :class="{ 'show': showAddRoleModal }">
        <div class="modal-box">
            <div class="modal-title" style="margin-bottom:15px; font-weight:600;">添加新角色</div>
            <input type="text" class="glass-input" v-model="newRoleName" placeholder="输入角色名字..." style="margin-bottom:10px;">
            <div class="modal-actions">
                <div class="glass-btn" @click="showAddRoleModal = false">取消</div>
                <div class="glass-btn" style="background: rgba(255,255,255,0.3);" @click="confirmAddRole">完成</div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" :class="{ 'show': showSaveModal }">
        <div class="modal-box">
            <div class="modal-title" style="margin-bottom:15px; font-weight:600;">命名预设</div>
            <input type="text" class="glass-input" v-model="newPresetName" placeholder="例如：GPT-4 Official" style="margin-bottom:10px;">
            <div class="modal-actions">
                <div class="glass-btn" @click="showSaveModal = false">取消</div>
                <div class="glass-btn" style="background: rgba(255,255,255,0.3);" @click="confirmSavePreset">确认</div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" :class="{ 'show': showDeleteModal }">
        <div class="modal-box">
            <div class="modal-title" style="margin-bottom:10px; font-weight:600;">确认删除</div>
            <div style="font-size:13px; color:#ccc; margin-bottom:20px;">{{ presets[selectedPresetId]?.name }}</div>
            <div class="modal-actions">
                <div class="glass-btn" @click="showDeleteModal = false">取消</div>
                <div class="glass-btn" style="background: rgba(255,59,48,0.4);" @click="confirmDeletePreset">删除</div>
            </div>
        </div>
    </div>

    <!-- 头像上传模态框 -->
    <div class="modal-overlay" :class="{ 'show': showAvatarModal }">
        <div class="modal-box" style="width: 320px;">
            <div class="modal-title" style="margin-bottom:15px; font-weight:600;">设置头像</div>
            
            <div class="form-group">
                <label class="form-label">头像URL</label>
                <input type="text" class="glass-input" v-model="avatarUrlInput" placeholder="输入图片URL">
            </div>
            
            <div style="text-align: center; margin: 15px 0; color: rgba(255,255,255,0.6); font-size: 14px;">或</div>
            
            <div class="form-group">
                <label class="form-label">上传本地图片</label>
                <div class="glass-btn" @click="triggerAvatarFileInput" style="width: 100%; justify-content: center;">
                    <i class="fas fa-upload" style="margin-right:6px"></i> 选择图片
                </div>
                <input type="file" ref="avatarFileInput" accept="image/*" style="display:none" @change="handleAvatarFile">
            </div>
            
            <div v-if="avatarPreviewUrl" class="avatar-preview-container" style="margin: 20px 0;">
                <div class="avatar-preview-label">预览</div>
                <div class="avatar-circle-preview" :style="{ backgroundImage: `url(${avatarPreviewUrl})` }"></div>
            </div>
            
            <div class="modal-actions">
                <div class="glass-btn" @click="cancelAvatarModal">取消</div>
                <div class="glass-btn" style="background: rgba(255,255,255,0.3);" @click="confirmAvatarChange">确认</div>
            </div>
        </div>
    </div>

    <!-- User预设保存模态框 -->
    <div class="modal-overlay" :class="{ 'show': showSaveUserPresetModal }">
        <div class="modal-box">
            <div class="modal-title" style="margin-bottom:15px; font-weight:600;">保存用户人设预设</div>
            <input type="text" class="glass-input" v-model="newUserPresetName" placeholder="输入预设名称..." style="margin-bottom:10px;">
            <div class="modal-actions">
                <div class="glass-btn" @click="showSaveUserPresetModal = false">取消</div>
                <div class="glass-btn" style="background: rgba(255,255,255,0.3);" @click="confirmSaveUserPreset">确认</div>
            </div>
        </div>
    </div>

    <!-- User预设删除模态框 -->
    <div class="modal-overlay" :class="{ 'show': showDeleteUserPresetModal }">
        <div class="modal-box">
            <div class="modal-title" style="margin-bottom:10px; font-weight:600;">确认删除预设</div>
            <div style="font-size:13px; color:#ccc; margin-bottom:20px;">{{ userPresets[selectedUserPresetId]?.name }}</div>
            <div class="modal-actions">
                <div class="glass-btn" @click="showDeleteUserPresetModal = false">取消</div>
                <div class="glass-btn" style="background: rgba(255,59,48,0.4);" @click="confirmDeleteUserPreset">删除</div>
            </div>
        </div>
    </div>

</div>

<script src="script.js"></script>

</body>
</html>
